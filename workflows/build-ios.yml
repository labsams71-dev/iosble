name: Build iOS App

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build:
    runs-on: macos-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Xcode
      uses: maxim-lobanov/setup-xcode@v1
      with:
        xcode-version: '15.0'
        
    - name: Build and Archive
      run: |
        xcodebuild -project BLE_Sniffer.xcodeproj \
                   -scheme BLE_Sniffer \
                   -configuration Release \
                   -destination generic/platform=iOS \
                   -archivePath BLE_Sniffer.xcarchive \
                   archive
                   
    - name: Export IPA
      run: |
        # Create export options
        cat > exportOptions.plist << EOF
        <?xml version="1.0" encoding="UTF-8"?>
        <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
        <plist version="1.0">
        <dict>
            <key>method</key>
            <string>development</string>
            <key>teamID</key>
            <string></string>
            <key>signingStyle</key>
            <string>manual</string>
            <key>stripSwiftSymbols</key>
            <true/>
            <key>uploadBitcode</key>
            <false/>
            <key>uploadSymbols</key>
            <false/>
        </dict>
        </plist>
        EOF
        
        # Export IPA
        xcodebuild -exportArchive \
                   -archivePath BLE_Sniffer.xcarchive \
                   -exportPath export \
                   -exportOptionsPlist exportOptions.plist
                   
        # Move IPA to root
        mv export/BLE_Sniffer.ipa ./BLE_Sniffer.ipa
        
    - name: Upload IPA
      uses: actions/upload-artifact@v4
      with:
        name: BLE_Sniffer-IPA
        path: BLE_Sniffer.ipa
        
    - name: Create Release
      if: github.event_name == 'push' && github.ref == 'refs/heads/main'
      uses: actions/create-release@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: v${{ github.run_number }}
        release_name: Release v${{ github.run_number }}
        body: |
          ðŸš€ BLE Sniffer iOS App - Automatic Build
          
          ## What's New
          - Real BLE functionality (no simulations)
          - Dark Mode enabled
          - English interface
          - TrollStore ready
          
          ## Installation
          1. Download the IPA file
          2. Install via TrollStore
          3. Grant Bluetooth permissions
          4. Start scanning!
          
          ## Features
          - Scan nearby BLE devices
          - Save devices to library
          - Broadcast real BLE signals
          - Configure transmission parameters
          
          Built automatically on ${{ github.event.head_commit.timestamp }}
        draft: false
        prerelease: false
        
    - name: Upload Release Asset
      if: github.event_name == 'push' && github.ref == 'refs/heads/main'
      uses: actions/upload-release-asset@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        upload_url: ${{ steps.create_release.outputs.upload_url }}
        asset_path: ./BLE_Sniffer.ipa
        asset_name: BLE_Sniffer.ipa
        asset_content_type: application/octet-stream 